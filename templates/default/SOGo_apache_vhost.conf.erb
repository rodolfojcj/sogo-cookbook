#
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.
#
<%# https://ideasnet.wordpress.com/2013/03/22/ides-server-how-to-set-up-an-ubuntu-12-04lts-business-box-server-edition-part-2%E2%80%B3/  %>
<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  DocumentRoot /usr/lib/GNUstep/SOGo/WebServerResources/
  ServerSignature Off

  Alias /SOGo.woa/WebServerResources/ /usr/lib/GNUstep/SOGo/WebServerResources/
  Alias /SOGo/WebServerResources/ /usr/lib/GNUstep/SOGo/WebServerResources/
  AliasMatch /SOGo/so/ControlPanel/Products/(.*)/Resources/(.*) /usr/lib/GNUstep/SOGo/$1.SOGo/Resources/$2

  <Directory /usr/lib/GNUstep/SOGo/>
    AllowOverride None
<% if node['apache']['version'] == '2.4' -%>
    Require all granted
<% else -%>
    Order deny,allow
    Allow from all
<% end -%>
  </Directory>

  <LocationMatch "^/SOGo/so/ControlPanel/Products/.*UI/Resources/.*\.(jpg|png|gif|css|js)">
    SetHandler default-handler
  </LocationMatch>

  ProxyRequests Off
  SetEnv proxy-nokeepalive 1
  ProxyPreserveHost On
  ProxyPass /SOGo http://127.0.0.1:20000/SOGo retry=0

  <Proxy http://127.0.0.1:20000/SOGo>
    RequestHeader set "x-webobjects-server-port" "80"
    RequestHeader set "x-webobjects-server-name" "<%= @params[:server_name] %>"
    RequestHeader set "x-webobjects-server-url" "http://<%= @params[:server_name] %>"
    RequestHeader set "x-webobjects-server-protocol" "HTTP/1.0"
    RequestHeader set "x-webobjects-remote-host" %{REMOTE_HOST}e env=REMOTE_HOST
    AddDefaultCharset UTF-8
    Order allow,deny
    Allow from all
  </Proxy>

  ## We use mod_rewrite to pass remote address to the SOGo proxy.
  # The remote address will appear in SOGo's log files and in the X-Forward
  # header of emails.
  RewriteEngine On
  RewriteRule ^/SOGo/(.*)$ /SOGo/$1 [env=REMOTE_HOST:%{REMOTE_ADDR},PT]

  Redirect permanent /index.html http://<%= @params[:server_name] %>/SOGo

  LogLevel warn
  ErrorLog <%= @node[:apache][:log_dir] %>/<%= @params[:name] %>-error.log
  CustomLog <%= @node[:apache][:log_dir] %>/<%= @params[:name] %>-access.log combined

</VirtualHost>
