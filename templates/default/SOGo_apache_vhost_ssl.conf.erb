#
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.
#

# based on 'RewriteEngine On' setting and https://wiki.debian.org/SOGo
<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  RewriteEngine On
  RedirectMatch permanent ^/ https://<%= @params[:server_name] %>/SOGo
  RedirectMatch permanent ^/SOGo https://<%= @params[:server_name] %>/SOGo
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
  ServerName <%= @params[:server_name] %>
  SSLEngine On
<% @params[:ssl_params].each do |param, value| -%>
  <%= param %> <%= value %>
<% end -%>

  DocumentRoot /usr/lib/GNUstep/SOGo/WebServerResources/
  ServerSignature Off

  Alias /SOGo.woa/WebServerResources/ /usr/lib/GNUstep/SOGo/WebServerResources/
  Alias /SOGo/WebServerResources/ /usr/lib/GNUstep/SOGo/WebServerResources/
  AliasMatch /SOGo/so/ControlPanel/Products/(.*)/Resources/(.*) /usr/lib/GNUstep/SOGo/$1.SOGo/Resources/$2

  <Directory /usr/lib/GNUstep/SOGo/>
    AllowOverride None
<% if node['apache']['version'] == '2.4' -%>
    Require all granted
<% else -%>
    Order deny,allow
    Allow from all
<% end -%>
  </Directory>

  <LocationMatch "^/SOGo/so/ControlPanel/Products/.*UI/Resources/.*\.(jpg|png|gif|css|js)">
    SetHandler default-handler
  </LocationMatch>

  ProxyRequests Off
  SetEnv proxy-nokeepalive 1
  ProxyPreserveHost On
  ProxyPass /SOGo http://127.0.0.1:20000/SOGo retry=0

  <Proxy http://127.0.0.1:20000/SOGo>
    RequestHeader set "x-webobjects-server-port" "443"
    RequestHeader set "x-webobjects-server-name" "<%= @params[:server_name] %>"
    RequestHeader set "x-webobjects-server-url" "https://<%= @params[:server_name] %>"
    RequestHeader set "x-webobjects-server-protocol" "HTTP/1.0"
    RequestHeader set "x-webobjects-remote-host" %{REMOTE_HOST}e env=REMOTE_HOST
    AddDefaultCharset UTF-8
<% if node['apache']['version'] == '2.4' -%>
    Require all granted
<% else -%>
    Order allow,deny
    Allow from all
<% end -%>
  </Proxy>

  ## We use mod_rewrite to pass remote address to the SOGo proxy.
  # The remote address will appear in SOGo's log files and in the X-Forward
  # header of emails.
  RewriteEngine On
  RewriteRule ^/SOGo/(.*)$ /SOGo/$1 [env=REMOTE_HOST:%{REMOTE_ADDR},PT]

  Redirect permanent /index.html https://<%= @params[:server_name] %>/SOGo

  LogLevel warn
  ErrorLog <%= @node[:apache][:log_dir] %>/<%= @params[:name] %>-error.log
  CustomLog <%= @node[:apache][:log_dir] %>/<%= @params[:name] %>-access.log combined

</VirtualHost>
</IfModule>
